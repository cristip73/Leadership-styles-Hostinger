{% extends "base.html" %}

{% block title %}Evaluare - Stil de Management{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Registration Form -->
        <div id="registrationSection" class="card shadow mb-4">
            <div class="card-body p-4">
                <h2 class="card-title mb-4">Înregistrare pentru Evaluare</h2>
                <p class="text-muted mb-4">Vă rugăm să completați informațiile dumneavoastră pentru a începe evaluarea.</p>
                
                <form id="registrationForm">
                    <div class="mb-3">
                        <label for="firstName" class="form-label">Prenume *</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Nume *</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        Începe Evaluarea
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Assessment Questions -->
        <div id="assessmentSection" class="card shadow mb-4" style="display: none;">
            <div class="card-body p-4">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <small>Progres</small>
                        <small id="progressText">0 din {{ questions|length }}</small>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Question Container -->
                <div id="questionContainer">
                    {% for question in questions %}
                    <div class="question-slide" data-question="{{ question.id }}" style="display: none;">
                        <h3 class="mb-3">Întrebarea {{ question.id }}</h3>
                        <p class="lead mb-4">{{ question.scenario }}</p>
                        
                        <div class="options">
                            {% for key, text in question.options.items() %}
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" 
                                       name="question{{ question.id }}" 
                                       id="q{{ question.id }}{{ key }}" 
                                       value="{{ key }}">
                                <label class="form-check-label" for="q{{ question.id }}{{ key }}">
                                    <strong>{{ key }}.</strong> {{ text }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary btn-prev" {% if loop.first %}disabled{% endif %}>
                                ← Înapoi
                            </button>
                            <button class="btn btn-primary btn-next" disabled>
                                {% if loop.last %}
                                    Finalizează Evaluarea
                                {% else %}
                                    Următoarea →
                                {% endif %}
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loadingSection" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Se procesează...</span>
            </div>
            <p class="mt-3">Se calculează rezultatele...</p>
        </div>
    </div>
</div>

<script>
// Store questions data
const questions = {{ questions|tojson }};
const totalQuestions = questions.length;
let currentQuestion = 0;
let responses = {};
let userId = null;

// Registration form handler
document.getElementById('registrationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: document.getElementById('email').value
    };
    
    try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            userId = data.user_id;
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('assessmentSection').style.display = 'block';
            showQuestion(0);
        } else {
            alert(data.error || 'Eroare la înregistrare');
        }
    } catch (error) {
        alert('Eroare de conexiune');
    }
});

// Show specific question
function showQuestion(index) {
    document.querySelectorAll('.question-slide').forEach(slide => {
        slide.style.display = 'none';
    });
    
    const currentSlide = document.querySelector(`[data-question="${index + 1}"]`);
    if (currentSlide) {
        currentSlide.style.display = 'block';
        currentQuestion = index;
        updateProgress();
    }
}

// Update progress bar
function updateProgress() {
    const answeredCount = Object.keys(responses).length;
    const percentage = (answeredCount / totalQuestions) * 100;
    
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressText').textContent = `${answeredCount} din ${totalQuestions}`;
}

// Handle radio button changes
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const questionId = this.name.replace('question', '');
        const nextBtn = this.closest('.question-slide').querySelector('.btn-next');
        nextBtn.disabled = false;
    });
});

// Handle navigation buttons
document.querySelectorAll('.btn-prev').forEach(btn => {
    btn.addEventListener('click', () => {
        if (currentQuestion > 0) {
            showQuestion(currentQuestion - 1);
        }
    });
});

document.querySelectorAll('.btn-next').forEach(btn => {
    btn.addEventListener('click', async function() {
        // Prevent double-click
        if (this.disabled) return;
        this.disabled = true;
        
        const questionSlide = this.closest('.question-slide');
        const questionId = parseInt(questionSlide.dataset.question);
        const selectedOption = questionSlide.querySelector('input[type="radio"]:checked');
        
        if (!selectedOption) {
            alert('Vă rugăm să selectați un răspuns');
            this.disabled = false;
            return;
        }
        
        // Save response
        responses[questionId] = selectedOption.value;
        
        // Debug log
        console.log(`Question ${questionId}: ${selectedOption.value}`);
        console.log(`Total responses so far: ${Object.keys(responses).length}`);
        
        // Submit answer to server
        try {
            const response = await fetch('/api/submit_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question_id: questionId,
                    answer: selectedOption.value
                })
            });
            
            const data = await response.json();
            console.log('Server response:', data);
            
            if (data.success) {
                if (data.completed) {
                    console.log('Assessment completed! Redirecting to results...');
                    // Assessment completed
                    document.getElementById('assessmentSection').style.display = 'none';
                    document.getElementById('loadingSection').style.display = 'block';
                    
                    // Redirect to results
                    setTimeout(() => {
                        window.location.href = `/results/${data.user_id}`;
                    }, 2000);
                } else {
                    // Move to next question
                    if (currentQuestion < totalQuestions - 1) {
                        showQuestion(currentQuestion + 1);
                    }
                    // Re-enable button for next question navigation
                    this.disabled = false;
                }
            } else {
                console.error('Server error:', data);
                alert(data.error || 'Eroare la salvarea răspunsului');
                this.disabled = false;
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Eroare de conexiune: ' + error.message);
            this.disabled = false;
        }
    });
});

// Initialize first question (will be shown after registration)
if (questions.length > 0 && !userId) {
    // Keep registration form visible initially
}
</script>
{% endblock %}